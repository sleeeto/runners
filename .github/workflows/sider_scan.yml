name: Sider Scan Runner

on:
  schedule:
    - cron: '0 5 * * 1-5'

jobs:
  scan-job:
    runs-on: ubuntu-20.04
    container:
      image: sider/sider_scan_runner:2.1.0
      env:
        TZ: Asia/Tokyo
      options: -v ${{github.workspace}}:/builds
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          ref: master
          persist-credentials: false
      - name: Download the passed radump
        continue-on-error: true
        run: |
          wget --header "Accept: application/vnd.github.v3+json" --header "Authorization: token ${{github.token}}" https://api.github.com/repos/${{github.repository}}/actions/artifacts -O - \
            | grep -o 'https://[^"]*/zip' \
            | head -n 1 \
            | wget -P /tmp --header "Authorization: token ${{github.token}}" --input-file - \
            && unzip /tmp/zip -d /tmp
      - run: |
          echo "{ \
            \"user\": { \"contactEmail\": \"dev@siderlabs.com\" }, \
            \"channels\": { \
              \"email\": { \
                \"useBuiltInProvider\": false, \
                \"providers\": [ \
                  { \
                    \"type\": \"smtp\", \
                    \"port\": 587, \
                    \"host\": \"${{ secrets.SIDERSCAN_MAILSERVER }}\", \
                    \"auth\": { \
                      \"type\": \"login\", \
                      \"user\": \"${{ secrets.SIDERSCAN_MAIL_KEY }}\", \
                      \"pass\": \"${{ secrets.SIDERSCAN_MAIL_SECRET }}\" \
                    }, \
                    \"secure\": true \
                  } \
                ], \
                \"defaults\": { \
                  \"from\": \"scan-dev@siderlabs.com\" \
                } \
              } \
            }, \
            \"report\": { \
              \"enableDetailReport\": true \
            } \
          }" > .siderscan.json
      - run: mkdir -p scan_result
      - name: Start analysis
        run: |
          sider run \
          -c ./.siderscan.json \
          -p ./ \
          -f /tmp/output.radump \
          -t "\"Sider Scan Developer\" <scan-dev@siderlabs.com>" \
          -o scan_result
      - name: Upload radump
        uses: actions/upload-artifact@v2
        with:
          name: radump
          path: /tmp/output.radump
